-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- โ  REDFLIX - SETUP COMPLETO DA TABELA KV STORE                  โ
-- โ  Projeto: vsztquvvnwlxdwyeoffh                                 โ
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASSO 1: CRIAR TABELA KV STORE
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

CREATE TABLE IF NOT EXISTS kv_store_2363f5d6 (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASSO 2: CRIAR รNDICE PARA BUSCAS POR PREFIXO
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

CREATE INDEX IF NOT EXISTS idx_kv_store_key_prefix 
ON kv_store_2363f5d6(key text_pattern_ops);

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASSO 3: CRIAR FUNรรO PARA ATUALIZAR TIMESTAMP
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

CREATE OR REPLACE FUNCTION update_kv_store_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASSO 4: CRIAR TRIGGER PARA ATUALIZAR AUTOMATICAMENTE
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DROP TRIGGER IF EXISTS update_kv_store_timestamp ON kv_store_2363f5d6;

CREATE TRIGGER update_kv_store_timestamp
  BEFORE UPDATE ON kv_store_2363f5d6
  FOR EACH ROW
  EXECUTE FUNCTION update_kv_store_updated_at();

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASSO 5: INSERIR DADOS DE TESTE
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

INSERT INTO kv_store_2363f5d6 (key, value) 
VALUES 
  ('test:connection', '{"status":"ok","message":"โ Banco conectado com sucesso!","timestamp":"' || NOW()::TEXT || '"}'),
  ('redflix:config', '{"app":"RedFlix","version":"1.0.0","color":"#E50914"}'),
  ('redflix:setup', '{"database":"configured","edge_function":"pending","status":"ready"}')
ON CONFLICT (key) DO UPDATE 
SET value = EXCLUDED.value, updated_at = NOW();

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASSO 6: VERIFICAR SE TUDO FUNCIONOU
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- Mostrar resumo
SELECT 
  'โ TABELA KV CRIADA COM SUCESSO!' as status,
  COUNT(*) as total_entries,
  NOW() as timestamp
FROM kv_store_2363f5d6;

-- Mostrar estrutura da tabela
SELECT 
  '๐ ESTRUTURA DA TABELA:' as info,
  column_name, 
  data_type, 
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'kv_store_2363f5d6'
ORDER BY ordinal_position;

-- Mostrar dados inseridos
SELECT 
  '๐ DADOS DE TESTE:' as info,
  key,
  value,
  created_at,
  updated_at
FROM kv_store_2363f5d6
ORDER BY key;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- โ SETUP COMPLETO!
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 
-- Prรณximo passo: Configurar Secrets da Edge Function
-- Veja: /PASSO_2_CONFIGURAR_SECRETS.md
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
